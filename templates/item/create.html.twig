{% extends 'base.html.twig' %}

{% block title %}{{ 'create_item.title'|trans({'%inventory%': inventory.title}) }}{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <!-- Навигационные breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('app_home') }}">{{ 'create_item.breadcrumb_home'|trans }}</a></li>
            <li class="breadcrumb-item"><a href="{{ path('inventory_show', {'id': inventory.id}) }}">{{ inventory.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ 'create_item.breadcrumb_create'|trans }}</li>
        </ol>
    </nav>

    <!-- Сообщения об успехе -->
    {% for message in app.flashes('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}

    <!-- Общие ошибки валидации -->
    {% if errors is defined and errors is not empty %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>{{ 'validation_errors.title'|trans }}</strong>
            <ul class="mb-0 mt-2">
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ 'create_item.heading'|trans }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('item_create', {'inventoryId': inventory.id}) }}" id="itemForm">
                        <input type="hidden" name="_token" value="{{ csrf_token('create_item') }}">

                        <!-- Фиксированные поля (только для чтения) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Custom ID</label>
                                <input type="text" class="form-control" value="{{ 'create_item.custom_id_placeholder'|trans }}" readonly>
                                <div class="form-text">{{ 'create_item.custom_id_help'|trans }}</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">{{ 'create_item.created_by_label'|trans }}</label>
                                <input type="text" class="form-control" value="{{ app.user.username ?: app.user.email }}" readonly>
                            </div>
                        </div>

                        <!-- Кастомные поля -->
                        {% for i in 1..3 %}
                            {% set stringState = attribute(inventory, 'customString' ~ i ~ 'State') %}
                            {% set stringName = attribute(inventory, 'customString' ~ i ~ 'Name') %}
                            {% set stringDesc = attribute(inventory, 'customString' ~ i ~ 'Description') %}

                            {% set textState = attribute(inventory, 'customText' ~ i ~ 'State') %}
                            {% set textName = attribute(inventory, 'customText' ~ i ~ 'Name') %}
                            {% set textDesc = attribute(inventory, 'customText' ~ i ~ 'Description') %}

                            {% set intState = attribute(inventory, 'customInt' ~ i ~ 'State') %}
                            {% set intName = attribute(inventory, 'customInt' ~ i ~ 'Name') %}
                            {% set intDesc = attribute(inventory, 'customInt' ~ i ~ 'Description') %}

                            {% set boolState = attribute(inventory, 'customBool' ~ i ~ 'State') %}
                            {% set boolName = attribute(inventory, 'customBool' ~ i ~ 'Name') %}
                            {% set boolDesc = attribute(inventory, 'customBool' ~ i ~ 'Description') %}

                            {% set linkState = attribute(inventory, 'customLink' ~ i ~ 'State') %}
                            {% set linkName = attribute(inventory, 'customLink' ~ i ~ 'Name') %}
                            {% set linkDesc = attribute(inventory, 'customLink' ~ i ~ 'Description') %}

                            {# String поля #}
                            {% if stringState %}
                                <div class="mb-3">
                                    <label for="custom_string{{ i }}_value" class="form-label">
                                        {{ stringName }}
                                        {% if stringDesc %}
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="{{ stringDesc }}"></i>
                                        {% endif %}
                                    </label>
                                    <input type="text"
                                           class="form-control"
                                           id="custom_string{{ i }}_value"
                                           name="custom_string{{ i }}_value"
                                           value="{{ formData['custom_string' ~ i ~ '_value'] ?? '' }}"
                                           maxlength="255"
                                           placeholder="{{ stringDesc }}">
                                </div>
                            {% endif %}

                            {# Text поля #}
                            {% if textState %}
                                <div class="mb-3">
                                    <label for="custom_text{{ i }}_value" class="form-label">
                                        {{ textName }}
                                        {% if textDesc %}
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="{{ textDesc }}"></i>
                                        {% endif %}
                                    </label>
                                    <textarea class="form-control"
                                              id="custom_text{{ i }}_value"
                                              name="custom_text{{ i }}_value"
                                              rows="3"
                                              placeholder="{{ textDesc }}">{{ formData['custom_text' ~ i ~ '_value'] ?? '' }}</textarea>
                                </div>
                            {% endif %}

                            {# Integer поля #}
                            {% if intState %}
                                <div class="mb-3">
                                    <label for="custom_int{{ i }}_value" class="form-label">
                                        {{ intName }}
                                        {% if intDesc %}
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="{{ intDesc }}"></i>
                                        {% endif %}
                                    </label>
                                    <input type="number"
                                           class="form-control"
                                           id="custom_int{{ i }}_value"
                                           name="custom_int{{ i }}_value"
                                           value="{{ formData['custom_int' ~ i ~ '_value'] ?? '' }}"
                                           placeholder="{{ intDesc }}">
                                </div>
                            {% endif %}

                            {# Boolean поля #}
                            {% if boolState %}
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               id="custom_bool{{ i }}_value"
                                               name="custom_bool{{ i }}_value"
                                               value="on"
                                               {{ (formData['custom_bool' ~ i ~ '_value'] ?? '') == 'on' ? 'checked' : '' }}>
                                        <label class="form-check-label" for="custom_bool{{ i }}_value">
                                            {{ boolName }}
                                            {% if boolDesc %}
                                                <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="{{ boolDesc }}"></i>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}

                            {# Link поля #}
                            {% if linkState %}
                                <div class="mb-3" data-controller="link-preview">
                                    <label for="custom_link{{ i }}_value" class="form-label">
                                        {{ linkName }}
                                        {% if linkDesc %}
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip" title="{{ linkDesc }}"></i>
                                        {% endif %}
                                    </label>
                                    <input type="url"
                                           class="form-control"
                                           id="custom_link{{ i }}_value"
                                           name="custom_link{{ i }}_value"
                                           value="{{ formData['custom_link' ~ i ~ '_value'] ?? '' }}"
                                           placeholder="{{ linkDesc }}"
                                           data-link-preview-target="input"
                                           data-action="input->link-preview#onInput">
                                    <div data-link-preview-target="preview" class="link-preview-container mt-2"></div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        <!-- Кнопки действий -->
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> {{ 'create_item.create_button'|trans }}
                            </button>
                            <a href="{{ path('inventory_show', {'id': inventory.id}) }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> {{ 'create_item.cancel_button'|trans }}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Боковая панель с информацией -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">{{ 'item_info.title'|trans }}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>{{ 'item_info.inventory'|trans }}</strong><br>
                        {{ inventory.title }}
                    </div>
                    <div class="mb-3">
                        <strong>{{ 'item_info.category'|trans }}</strong><br>
                        {{ inventory.category.name }}
                    </div>
                    <div class="mb-3">
                        <strong>{{ 'item_info.public_access'|trans }}</strong><br>
                        {% if inventory.isPublic %}
                            <span class="badge bg-success">{{ 'item_info.yes'|trans }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ 'item_info.no'|trans }}</span>
                        {% endif %}
                    </div>
                    {% if inventory.description is not empty %}
                        <div class="mb-0">
                            <strong>{{ 'item_info.description'|trans }}</strong><br>
                            {{ markdown_service.parseSafe(inventory.description)|raw }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Инициализация tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
